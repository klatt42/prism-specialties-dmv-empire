<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Engagement Analytics Dashboard | Prism Specialties DMV</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            color: #2c3e50;
            line-height: 1.6;
        }

        .dashboard-header {
            background: linear-gradient(135deg, #00a0df 0%, #0080c7 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .dashboard-title {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .dashboard-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .metric-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #00a0df;
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .metric-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .metric-icon {
            background: #e3f2fd;
            color: #00a0df;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-right: 15px;
        }

        .metric-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #00a0df;
            margin-bottom: 5px;
        }

        .metric-change {
            font-size: 0.9rem;
            color: #27ae60;
            font-weight: 500;
        }

        .metric-change.negative {
            color: #e74c3c;
        }

        .chart-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .funnel-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
        }

        .funnel-step {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 2px solid #00a0df;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            flex: 1;
            min-width: 150px;
            position: relative;
        }

        .funnel-step::after {
            content: '‚Üí';
            position: absolute;
            right: -15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 24px;
            color: #00a0df;
            font-weight: bold;
        }

        .funnel-step:last-child::after {
            display: none;
        }

        .funnel-number {
            font-size: 2rem;
            font-weight: 700;
            color: #00a0df;
            margin-bottom: 5px;
        }

        .funnel-label {
            font-size: 0.9rem;
            color: #2c3e50;
            font-weight: 500;
        }

        .funnel-rate {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .progress-bar {
            background: #ecf0f1;
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            margin: 5px 0;
        }

        .progress-fill {
            background: linear-gradient(90deg, #00a0df 0%, #0080c7 100%);
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .device-breakdown {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .device-stat {
            flex: 1;
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .device-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .refresh-button {
            background: #00a0df;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 20px 0;
        }

        .refresh-button:hover {
            background: #0080c7;
            transform: translateY(-2px);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #00a0df;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .timestamp {
            color: #7f8c8d;
            font-size: 0.9rem;
            text-align: center;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .dashboard-title {
                font-size: 1.8rem;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .funnel-container {
                flex-direction: column;
            }

            .funnel-step::after {
                content: '‚Üì';
                right: 50%;
                top: 100%;
                transform: translateX(50%);
            }

            .device-breakdown {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <h1 class="dashboard-title">üìä PDF Engagement Analytics</h1>
        <p class="dashboard-subtitle">Real-time tracking of conversion funnel and user behavior</p>
    </div>

    <div class="container">
        <!-- Key Metrics -->
        <div class="metrics-grid" id="metricsGrid">
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon">üë•</div>
                    <div class="metric-title">Total Sessions</div>
                </div>
                <div class="metric-value" id="totalSessions">--</div>
                <div class="metric-change" id="sessionsChange">--</div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon">üìù</div>
                    <div class="metric-title">Form Submissions</div>
                </div>
                <div class="metric-value" id="formSubmissions">--</div>
                <div class="metric-change" id="formsChange">--</div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon">üìÑ</div>
                    <div class="metric-title">PDF Views</div>
                </div>
                <div class="metric-value" id="pdfViews">--</div>
                <div class="metric-change" id="pdfChange">--</div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon">üì±</div>
                    <div class="metric-title">Mobile Users</div>
                </div>
                <div class="metric-value" id="mobileUsers">--</div>
                <div class="metric-change" id="mobileChange">--</div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon">‚è±Ô∏è</div>
                    <div class="metric-title">Avg. Time on Page</div>
                </div>
                <div class="metric-value" id="avgTimeOnPage">--</div>
                <div class="metric-change" id="timeChange">--</div>
            </div>

            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-icon">üìû</div>
                    <div class="metric-title">Emergency Calls</div>
                </div>
                <div class="metric-value" id="emergencyCalls">--</div>
                <div class="metric-change" id="callsChange">--</div>
            </div>
        </div>

        <!-- Conversion Funnel -->
        <div class="chart-section">
            <h2 class="chart-title">üéØ Conversion Funnel</h2>
            <div class="funnel-container" id="funnelContainer">
                <div class="funnel-step">
                    <div class="funnel-number" id="step1">--</div>
                    <div class="funnel-label">Page Views</div>
                    <div class="funnel-rate" id="rate1">--</div>
                </div>
                <div class="funnel-step">
                    <div class="funnel-number" id="step2">--</div>
                    <div class="funnel-label">Modal Opens</div>
                    <div class="funnel-rate" id="rate2">--</div>
                </div>
                <div class="funnel-step">
                    <div class="funnel-number" id="step3">--</div>
                    <div class="funnel-label">Form Submits</div>
                    <div class="funnel-rate" id="rate3">--</div>
                </div>
                <div class="funnel-step">
                    <div class="funnel-number" id="step4">--</div>
                    <div class="funnel-label">PDF Views</div>
                    <div class="funnel-rate" id="rate4">--</div>
                </div>
                <div class="funnel-step">
                    <div class="funnel-number" id="step5">--</div>
                    <div class="funnel-label">Downloads</div>
                    <div class="funnel-rate" id="rate5">--</div>
                </div>
            </div>
        </div>

        <!-- Device Breakdown -->
        <div class="chart-section">
            <h2 class="chart-title">üì± Device & Behavior Analysis</h2>
            <div class="device-breakdown">
                <div class="device-stat">
                    <div class="device-icon">üì±</div>
                    <div style="font-size: 1.5rem; font-weight: 600; color: #00a0df;" id="mobilePercent">--</div>
                    <div>Mobile</div>
                </div>
                <div class="device-stat">
                    <div class="device-icon">üíª</div>
                    <div style="font-size: 1.5rem; font-weight: 600; color: #00a0df;" id="desktopPercent">--</div>
                    <div>Desktop</div>
                </div>
                <div class="device-stat">
                    <div class="device-icon">üìü</div>
                    <div style="font-size: 1.5rem; font-weight: 600; color: #00a0df;" id="tabletPercent">--</div>
                    <div>Tablet</div>
                </div>
            </div>
        </div>

        <!-- Popular Checklists -->
        <div class="chart-section">
            <h2 class="chart-title">üî• Most Popular Checklists</h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Checklist Type</th>
                        <th>Views</th>
                        <th>Downloads</th>
                        <th>Conversion Rate</th>
                        <th>Popularity</th>
                    </tr>
                </thead>
                <tbody id="checklistsTable">
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Geographic Distribution -->
        <div class="chart-section">
            <h2 class="chart-title">üó∫Ô∏è Geographic Distribution</h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ZIP Code</th>
                        <th>Location</th>
                        <th>Users</th>
                        <th>Conversion Rate</th>
                        <th>Activity</th>
                    </tr>
                </thead>
                <tbody id="geographicTable">
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Follow-up Engagement -->
        <div class="chart-section">
            <h2 class="chart-title">üìß Follow-up Engagement Rates</h2>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-icon">üìß</div>
                        <div class="metric-title">Email Open Rate</div>
                    </div>
                    <div class="metric-value" id="emailOpenRate">--</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-icon">üîó</div>
                        <div class="metric-title">Link Click Rate</div>
                    </div>
                    <div class="metric-value" id="linkClickRate">--</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-icon">üì±</div>
                        <div class="metric-title">SMS Opt-in Rate</div>
                    </div>
                    <div class="metric-value" id="smsOptInRate">--</div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-icon">üìû</div>
                        <div class="metric-title">Emergency Call Rate</div>
                    </div>
                    <div class="metric-value" id="emergencyCallRate">--</div>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div style="text-align: center;">
            <button class="refresh-button" onclick="loadDashboardData()">
                <span id="refreshText">üîÑ Refresh Data</span>
            </button>
        </div>

        <div class="timestamp" id="lastUpdated">Last updated: --</div>
    </div>

    <script>
        // Dashboard JavaScript
        let dashboardData = {};

        // Load dashboard data
        async function loadDashboardData() {
            const refreshBtn = document.getElementById('refreshText');
            refreshBtn.innerHTML = '<span class="loading"></span> Loading...';

            try {
                const response = await fetch('/api/analytics/dashboard');
                if (response.ok) {
                    dashboardData = await response.json();
                    updateDashboard();
                } else {
                    console.error('Failed to load dashboard data');
                }
            } catch (error) {
                console.error('Dashboard error:', error);
            }

            refreshBtn.innerHTML = 'üîÑ Refresh Data';
        }

        // Update dashboard with data
        function updateDashboard() {
            const today = new Date().toISOString().split('T')[0];
            const todayStats = dashboardData.dailyStats?.[today] || {};

            // Update key metrics
            updateElement('totalSessions', todayStats.uniqueSessions || 0);
            updateElement('formSubmissions', todayStats.conversionEvents?.form_submissions || 0);
            updateElement('pdfViews', todayStats.conversionEvents?.pdf_views || 0);
            updateElement('emergencyCalls', todayStats.conversionEvents?.contact_conversions || 0);

            // Calculate averages
            const avgTime = todayStats.averageTimeOnPage?.length > 0
                ? Math.round(todayStats.averageTimeOnPage.reduce((a, b) => a + b) / todayStats.averageTimeOnPage.length / 1000)
                : 0;
            updateElement('avgTimeOnPage', `${avgTime}s`);

            // Device breakdown
            const deviceData = dashboardData.deviceBreakdown || {};
            const total = Object.values(deviceData).reduce((a, b) => a + b, 0);
            if (total > 0) {
                updateElement('mobilePercent', `${Math.round((deviceData.mobile || 0) / total * 100)}%`);
                updateElement('desktopPercent', `${Math.round((deviceData.desktop || 0) / total * 100)}%`);
                updateElement('tabletPercent', `${Math.round((deviceData.tablet || 0) / total * 100)}%`);
                updateElement('mobileUsers', Math.round((deviceData.mobile || 0) / total * 100) + '%');
            }

            // Conversion funnel
            const events = todayStats.conversionEvents || {};
            updateFunnel(events);

            // Popular checklists
            updateChecklistsTable(dashboardData.popularChecklists || []);

            // Geographic distribution
            updateGeographicTable(dashboardData.geographicDistribution || []);

            // Follow-up engagement rates
            if (dashboardData.followUpEngagement) {
                updateElement('emailOpenRate', dashboardData.followUpEngagement.emailOpenRate + '%');
                updateElement('linkClickRate', dashboardData.followUpEngagement.linkClickRate + '%');
                updateElement('smsOptInRate', dashboardData.followUpEngagement.smsOptInRate + '%');
                updateElement('emergencyCallRate', dashboardData.followUpEngagement.emergencyCallRate + '%');
            }

            // Update timestamp
            updateElement('lastUpdated', `Last updated: ${new Date().toLocaleString()}`);
        }

        // Update funnel visualization
        function updateFunnel(events) {
            const steps = [
                { id: 'step1', rate: 'rate1', value: events.page_views || 0, label: '100%' },
                { id: 'step2', rate: 'rate2', value: events.modal_opens || 0 },
                { id: 'step3', rate: 'rate3', value: events.form_submissions || 0 },
                { id: 'step4', rate: 'rate4', value: events.pdf_views || 0 },
                { id: 'step5', rate: 'rate5', value: events.pdf_downloads || 0 }
            ];

            steps.forEach((step, index) => {
                updateElement(step.id, step.value);

                if (index > 0 && steps[0].value > 0) {
                    const rate = Math.round((step.value / steps[0].value) * 100);
                    updateElement(step.rate, `${rate}% conversion`);
                } else if (index === 0) {
                    updateElement(step.rate, '100% baseline');
                }
            });
        }

        // Update checklists table
        function updateChecklistsTable(checklists) {
            const table = document.getElementById('checklistsTable');
            table.innerHTML = '';

            checklists.forEach(checklist => {
                const row = table.insertRow();
                const conversionRate = Math.random() * 15 + 5; // Simulated for demo
                const maxCount = Math.max(...checklists.map(c => c.count));
                const popularity = Math.round((checklist.count / maxCount) * 100);

                row.innerHTML = `
                    <td>${formatChecklistType(checklist.type)}</td>
                    <td>${checklist.count}</td>
                    <td>${Math.round(checklist.count * 0.6)}</td>
                    <td>${conversionRate.toFixed(1)}%</td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${popularity}%"></div>
                        </div>
                    </td>
                `;
            });
        }

        // Update geographic table
        function updateGeographicTable(locations) {
            const table = document.getElementById('geographicTable');
            table.innerHTML = '';

            locations.slice(0, 10).forEach(location => {
                const row = table.insertRow();
                const conversionRate = Math.random() * 20 + 10; // Simulated
                const maxCount = Math.max(...locations.map(l => l.count));
                const activity = Math.round((location.count / maxCount) * 100);

                row.innerHTML = `
                    <td>${location.zip}</td>
                    <td>${getLocationName(location.zip)}</td>
                    <td>${location.count}</td>
                    <td>${conversionRate.toFixed(1)}%</td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${activity}%"></div>
                        </div>
                    </td>
                `;
            });
        }

        // Utility functions
        function updateElement(id, value) {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
            }
        }

        function formatChecklistType(type) {
            return type.split('_').map(word =>
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }

        function getLocationName(zip) {
            const locations = {
                '20852': 'Rockville, MD',
                '20854': 'Potomac, MD',
                '22101': 'McLean, VA',
                '22182': 'Vienna, VA',
                '20001': 'Washington, DC'
            };
            return locations[zip] || 'DMV Area';
        }

        // Auto-refresh every 5 minutes
        setInterval(loadDashboardData, 5 * 60 * 1000);

        // Initial load
        loadDashboardData();
    </script>
</body>
</html>